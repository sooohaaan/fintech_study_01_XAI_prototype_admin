{% extends "base.html" %}
{% block content %}
<h1>포인트 생애주기 관리</h1>

<div class="card guide-card">
    <div class="card-p">
        <div class="flex items-center gap-2 mb-2">
            <span class="badge badge-info">Tokenomics</span>
            <h3 class="font-bold text-sm">포인트 순환 구조 (Lifecycle)</h3>
        </div>
        <div class="text-sm text-sub space-y-2">
            <p>TrustFin 포인트 시스템은 <strong>발행(Minting) → 지급(Allocation) → 유통(Circulation) → 소각(Burn)</strong>의 생애주기를 가집니다.</p>
            <ul style="list-style-type: disc; padding-left: 20px; margin: 0;">
                <li><strong>지급 (Earning):</strong> 미션 달성 시 시스템 풀에서 사용자에게 포인트가 지급됩니다. (동기 부여)</li>
                <li><strong>사용 (Spending):</strong> 포인트 상품 구매 시 포인트가 회수되어 소각됩니다. (가치 실현)</li>
                <li><strong>소멸/회수 (Expiration/Clawback):</strong> 유효기간 만료 또는 어뷰징 적발 시 포인트를 회수하여 총 유통량을 조절합니다.</li>
            </ul>
        </div>
    </div>
</div>

<div class="info-banner">전체 포인트의 공급량과 유통량을 모니터링하고, 개별 유저의 포인트 흐름을 제어합니다.</div>

<form method="get" class="mb-6 bg-soft rounded-lg flex gap-2 items-center flex-wrap p-4">
    <span class="font-semibold text-sub">기간 설정:</span>
    <input type="date" name="start_date" value="{{ start_date or '' }}" class="form-input w-auto">
    <span class="text-sub">~</span>
    <input type="date" name="end_date" value="{{ end_date or '' }}" class="form-input w-auto">
    <input type="text" name="search_user" value="{{ search_user }}" placeholder="유저 ID 검색" class="form-input w-auto">
    <button type="submit" class="btn-primary">조회</button>
    <a href="/points" class="nav-btn">전체 기간</a>
</form>

<div class="summary-grid mb-6">
    <div class="summary-card">
        <div class="summary-label">총 발행량 (Minted)</div>
        <div class="summary-value text-success">{{ "{:,}".format(total_minted) }}</div>
        <p class="help-text">지급된 포인트 총액</p>
    </div>
    <div class="summary-card">
        <div class="summary-label">현재 유통량 (Circulating)</div>
        <div class="summary-value text-primary">{{ "{:,}".format(total_balance) }}</div>
        <p class="help-text">현재 유저 보유 잔액 (Snapshot)</p>
    </div>
    <div class="summary-card">
        <div class="summary-label">총 사용 (Spent)</div>
        <div class="summary-value text-danger">{{ "{:,}".format(total_spent_purchase) }}</div>
        <p class="help-text">상품 구매로 소각된 포인트</p>
    </div>
    <div class="summary-card">
        <div class="summary-label">기타 감소 (Clawback/Expired)</div>
        <div class="summary-value text-sub">{{ "{:,}".format(total_clawback + total_expired) }}</div>
        <p class="help-text" title="회수: {{ '{:,}'.format(total_clawback) }} / 소멸: {{ '{:,}'.format(total_expired) }}">
            회수: {{ "{:,}".format(total_clawback) }} / 소멸: {{ "{:,}".format(total_expired) }}</p>
    </div>
    <div class="summary-card">
        <div class="summary-label">참여 유저 수</div>
        <div class="summary-value">{{ user_count }}</div>
        <p class="help-text">포인트 시스템 활성 유저</p>
    </div>
</div>

<div class="card card-p mb-6">
    <h3 class="card-title text-primary mt-0">포인트 유동성 제어 (Manual Control)</h3>
    <div class="warn-banner">특정 유저에게 포인트를 추가 지급(Mint)하거나, 보유 포인트를 회수(Burn)합니다.</div>
    <form method="post" action="/points/adjust" class="grid-3 gap-4 items-end">
        <div>
            <label class="form-label text-sm">대상 유저 ID</label>
            <input type="text" name="user_id" placeholder="예: user_001" required class="form-input">
        </div>
        <div>
            <label class="form-label text-sm">조정 금액</label>
            <input type="number" name="amount" placeholder="양수: 지급 / 음수: 회수" required class="form-input">
        </div>
        <div>
            <label class="form-label text-sm">조정 사유 (Audit Log)</label>
            <input type="text" name="reason" placeholder="예: 시스템 오류 보상, 어뷰징 회수" required class="form-input">
        </div>
        <div class="col-span-3 flex justify-end mt-2" style="grid-column: span 3;">
            <button type="submit" class="btn-primary">실행</button>
        </div>
    </form>
</div>

<div class="table-wrapper">
    <div class="flex justify-between items-center mb-4">
        <h3 class="card-title text-sm mt-0">유저별 보유 현황</h3>
    </div>
    <table class="w-full">
        <thead><tr>
            <th>유저 ID</th>
            <th class="text-right">보유 잔액 (Balance)</th>
            <th class="text-right">누적 획득 (Earned)</th>
            <th class="text-right">누적 사용 (Spent)</th>
            <th>최근 변동일</th>
            <th class="text-center">상세 내역</th>
        </tr></thead>
        <tbody>
            {% for u in users %}
            <tr>
                <td class="font-bold">{{ u.user_id }}</td>
                <td class="text-right font-bold text-primary">{{ "{:,}".format(u.balance) }}</td>
                <td class="text-right text-success">+{{ "{:,}".format(u.total_earned) }}</td>
                <td class="text-right text-danger">-{{ "{:,}".format(u.total_spent) }}</td>
                <td>{{ u.updated_at if u.updated_at else '-' }}</td>
                <td class="text-center">
                    <a href="/points/{{ u.user_id }}" class="btn-tonal btn-sm">Transaction</a>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center text-sub p-4">포인트 데이터가 없습니다.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="flex justify-between items-center mt-4">
    {% if page > 1 %}<a href="{{ url_for('points', page=page-1, start_date=start_date, end_date=end_date, search_user=search_user) }}" class="nav-btn">이전</a>
    {% else %}<span class="nav-btn" style="opacity: 0.5; cursor: default;">이전</span>{% endif %}
    <span class="text-sub font-bold">Page <span class="text-primary">{{ page }}</span> / {{ total_pages }}</span>
    {% if page < total_pages %}<a href="{{ url_for('points', page=page+1, start_date=start_date, end_date=end_date, search_user=search_user) }}" class="nav-btn">다음</a>
    {% else %}<span class="nav-btn" style="opacity: 0.5; cursor: default;">다음</span>{% endif %}
</div>
{% endblock %}