{% extends "base.html" %}
{% from "macros.html" import guide_card, summary_grid, empty_state, pagination %}
{% block content %}
<h1>대출 상품 관리</h1>

{{ guide_card("운영 관리", "상품 노출 제어",
    "수집된 금융 상품 중 판매 중단·정책상 노출 제한이 필요한 경우 관리자가 직접 노출 여부를 제어합니다. 비노출 처리된 상품은 추천 결과에서 제외됩니다.",
    [
        {"title": "상품 조회", "desc": "현재 수집된 금융 상품 목록과 노출 상태를 확인합니다."},
        {"title": "노출 제어", "desc": "토글 스위치로 상품의 사용자 노출 여부를 즉시 변경합니다."}
    ]) }}

{{ summary_grid([
    {"label": "전체 상품", "value": total_count, "title": "수집된 대출 상품의 전체 건수입니다."},
    {"label": "노출 중", "value": visible_count, "color": "success", "title": "현재 사용자에게 노출 중인 상품 수입니다."},
    {"label": "비노출", "value": hidden_count, "color": "danger"}
], "mb-6", title="상품 현황", badge="Products") }}

<div class="flex justify-between items-center mb-6 flex-wrap gap-2">
    <form method="get" class="flex gap-2 items-center flex-wrap">
        <input type="text" name="search" value="{{ search }}" placeholder="은행 또는 상품명 검색..." class="form-input w-auto min-w-200">
        <button type="submit" class="btn-accent">검색</button>
        {% if search %}<a href="/products" class="nav-btn">초기화</a>{% endif %}
    </form>
</div>

<div class="table-wrapper">
    <table class="w-full">
    </div>
</div>

<div class="table-wrapper">
    <table class="w-full">
        <thead><tr>
            <th>은행</th>
            <th>상품명</th>
            <th class="text-right">최저 금리</th>
            <th class="text-right">최고 금리</th>
            <th class="text-right">대출 한도</th>
            <th class="text-center">상태</th>
            <th class="text-center">관리</th>
        </tr></thead>
        <tbody>
            {% for p in products %}
            <tr>
                <td>{{ p.bank_name }}</td>
                <td class="font-bold">{{ p.product_name }}</td>
                <td class="text-right">{{ p.loan_rate_min }}%</td>
                <td class="text-right">{{ p.loan_rate_max }}%</td>
                <td class="text-right">{{ "{:,.0f}".format(p.loan_limit) }}원</td>
                <td class="text-center">
                    {% if p.is_visible == 1 %}
                        <span class="badge badge-success">노출</span>
                    {% else %}
                        <span class="badge badge-danger">비노출</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <form action="/products/toggle_visibility" method="post" class="form-inline">
                        <input type="hidden" name="bank_name" value="{{ p.bank_name }}">
                        <input type="hidden" name="product_name" value="{{ p.product_name }}">
                        <button type="submit" class="{{ 'btn-outline-danger' if p.is_visible == 1 else 'btn-outline-success' }}">
                            {{ '비노출 처리' if p.is_visible == 1 else '노출 처리' }}
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            {{ empty_state(7, "등록된 상품이 없습니다.") }}
            {% endfor %}
        </tbody>
    </table>
</div>

{{ pagination(page, total_pages,
    url_for('products', page=page-1, search=search),
    url_for('products', page=page+1, search=search)) }}
{% endblock %}