{% extends "base.html" %}
{% block content %}
<h1>미션 관리</h1>

<div class="card guide-card">
    <div class="card-p">
        <div class="flex items-center gap-2 mb-2">
            <span class="badge badge-info">행동 경제학 적용</span>
            <h3 class="font-bold text-sm">금융 행동 변화 유도 (Nudge)</h3>
        </div>
        <p class="text-sm text-sub">
            TrustFin은 단순히 대출을 추천하는 것을 넘어, 사용자가 <strong>더 나은 금융 조건</strong>을 갖추도록 돕습니다. AI가 분석한 사용자의 취약점(예: 낮은 신용점수, 부족한 자산)을 보완할 수 있는 구체적인 행동을 <strong>'미션'</strong> 형태로 제안합니다. <br>이 페이지에서는 생성된 미션들의 현황을 모니터링하여, 사용자들이 실제로 금융 행동을 변화시키고 있는지 파악합니다.
        </p>
    </div>
</div>

<div class="info-banner">AI가 유저의 대출 목적과 재무 상황을 바탕으로 자동 생성한 미션 목록입니다.</div>

<div class="summary-grid mb-6">
    <div class="summary-card">
        <div class="summary-label">전체 미션</div>
        <div class="summary-value">{{ total }}</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">대기(pending)</div>
        <div class="summary-value text-sub">{{ pending }}</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">진행(in_progress)</div>
        <div class="summary-value text-primary">{{ in_progress }}</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">완료(completed)</div>
        <div class="summary-value text-success">{{ completed }}</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">완료율</div>
        <div class="summary-value text-primary">{{ "%.1f" | format(completion_rate) }}%</div>
    </div>
</div>

<div class="card card-p mb-6">
    <h3 class="card-title text-primary text-sm mt-0">유형별 분포</h3>
    {% for type_name, count in type_counts.items() %}
    <div class="flex items-center mb-2 gap-2">
        <span style="width: 90px; font-size: 0.85rem; font-weight: 600;">{{ type_name }}</span>
        <div style="flex: 1; background: var(--border-light); border-radius: 8px; height: 20px;">
            <div style="background: var(--primary); height: 100%; border-radius: var(--radius-btn); width: {{ (count / total * 100) if total > 0 else 0 }}%; min-width: 2px;"></div>
        </div>
        <span style="width: 30px; text-align: right; font-size: 0.85rem;">{{ count }}</span>
    </div>
    {% endfor %}
</div>

<form method="get" class="mb-4 bg-soft rounded-lg flex gap-2 items-center flex-wrap p-4">
    <span class="font-semibold text-sub">필터:</span>
    <select name="status_filter" class="form-select w-auto">
        <option value="">전체 상태</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>대기 (pending)</option>
        <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>진행 (in_progress)</option>
        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>완료 (completed)</option>
        <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>만료 (expired)</option>
    </select>
    <select name="type_filter" class="form-select w-auto">
        <option value="">전체 유형</option>
        <option value="savings" {% if type_filter == 'savings' %}selected{% endif %}>savings (저축)</option>
        <option value="spending" {% if type_filter == 'spending' %}selected{% endif %}>spending (지출 절감)</option>
        <option value="credit" {% if type_filter == 'credit' %}selected{% endif %}>credit (신용 관리)</option>
        <option value="investment" {% if type_filter == 'investment' %}selected{% endif %}>investment (투자)</option>
        <option value="lifestyle" {% if type_filter == 'lifestyle' %}selected{% endif %}>lifestyle (생활 습관)</option>
    </select>
    <button type="submit" class="btn-accent" style="padding: 8px 16px;">적용</button>
    {% if status_filter or type_filter %}
        <a href="/missions" class="nav-btn">초기화</a>
    {% endif %}
</form>

<div class="table-wrapper">
    <table class="w-full">
        <thead><tr>
            <th>ID</th>
            <th>유저</th>
            <th>미션 제목</th>
            <th>유형</th>
            <th>대출 목적</th>
            <th>상태</th>
            <th>난이도</th>
            <th>포인트</th>
            <th>마감일</th>
        </tr></thead>
        <tbody>
            {% for m in missions %}
            <tr>
                <td>{{ m.mission_id }}</td>
                <td>{{ m.user_id }}</td>
                <td class="font-bold">
                    <a href="/missions/{{ m.mission_id }}" class="text-primary" style="text-decoration: none;">{{ m.mission_title }}</a>
                </td>
                <td><span class="badge badge-info">{{ m.mission_type }}</span></td>
                <td>{{ m.loan_purpose or '-' }}</td>
                <td>
                    {% if m.status == 'completed' %}
                        <span class="badge badge-success">completed</span>
                    {% elif m.status == 'in_progress' %}
                        <span class="badge badge-info">in_progress</span>
                    {% elif m.status == 'expired' %}
                        <span class="badge badge-danger">expired</span>
                    {% else %}
                        <span class="badge badge-warning">pending</span>
                    {% endif %}
                </td>
                <td>{{ m.difficulty }}</td>
                <td>{{ m.reward_points }}</td>
                <td>{{ m.due_date or '-' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="9" class="text-center text-sub p-4">미션이 없습니다.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}