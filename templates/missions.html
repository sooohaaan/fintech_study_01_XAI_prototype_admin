{% extends "base.html" %}
{% from "macros.html" import guide_card, summary_grid, filter_form, status_badge, empty_state, pagination %}
{% block content %}
<div class="flex justify-between items-center mb-2">
    <h1>ë¯¸ì…˜ ê´€ë¦¬</h1>
    <a href="/missions/deletion-logs" class="nav-btn">
        ğŸ—‘ï¸ ì‚­ì œ ë¡œê·¸ ì¡°íšŒ
        {% if deleted_count > 0 %}
        <span class="badge badge-danger" style="font-size: 0.75em; padding: 2px 6px;">{{ deleted_count }}</span>
        {% endif %}
    </a>
</div>

{{ guide_card("í–‰ë™ ê²½ì œí•™ ì ìš©", "ê¸ˆìœµ í–‰ë™ ë³€í™” ìœ ë„ (Nudge)",
    "AIê°€ ë¶„ì„í•œ ì‚¬ìš©ìì˜ ì·¨ì•½ì (ì˜ˆ: ë‚®ì€ ì‹ ìš©ì ìˆ˜, ë¶€ì¡±í•œ ìì‚°)ì„ ë³´ì™„í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ í–‰ë™ì„ 'ë¯¸ì…˜' í˜•íƒœë¡œ ì œì•ˆí•©ë‹ˆë‹¤. ìƒì„±ëœ ë¯¸ì…˜ í˜„í™©ì„ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ì‚¬ìš©ìë“¤ì˜ ê¸ˆìœµ í–‰ë™ ë³€í™”ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.",
    [
        {"title": "ë¯¸ì…˜ í˜„í™© ì¡°íšŒ", "desc": "AIê°€ ìë™ ìƒì„±í•œ ë¯¸ì…˜ì˜ ë‹¬ì„± ìƒíƒœì™€ í†µê³„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤."},
        {"title": "ë¯¸ì…˜ ê´€ë¦¬", "desc": "ê°œë³„ ë¯¸ì…˜ì˜ ìƒíƒœë¥¼ ê²€í† í•˜ê³  í•„ìš” ì‹œ ì‚­ì œí•©ë‹ˆë‹¤."}
    ]) }}

{{ summary_grid([
    {"label": "ì „ì²´ ë¯¸ì…˜", "value": total},
    {"label": "ëŒ€ê¸°(pending)", "value": pending, "color": "sub"},
    {"label": "ì§„í–‰(in_progress)", "value": in_progress, "color": "primary"},
    {"label": "ì™„ë£Œ(completed)", "value": completed, "color": "success"},
    {"label": "ë§Œë£Œ(expired)", "value": expired, "color": "danger"},
    {"label": "í¬ê¸°(given_up)", "value": given_up, "color": "sub"},
    {"label": "ì™„ë£Œìœ¨", "value": "%.1f" | format(completion_rate) ~ "%", "color": "primary", "title": type_completion_tooltip}
], "mb-6", title="ë¯¸ì…˜ í˜„í™©", badge="Missions") }}

<div class="card card-p mb-6">
    <h3 class="card-title text-primary text-sm mt-0">ìœ í˜•ë³„ ë¶„í¬</h3>
    {% for type_name, count in type_counts.items() %}
    {% set rate = type_rates.get(type_name, 0) %}
    <div class="flex items-center mb-2 gap-2">
        <span style="width: 90px; font-size: 0.85rem; font-weight: 600; {{ 'color: var(--danger-fg);' if rate < 50 else '' }}" title="ì™„ë£Œìœ¨: {{ '%.1f'|format(rate) }}%">{{ type_name }}</span>
        <div class="progress-track" style="flex: 1;">
            <div class="progress-fill" style="width: {{ (count / total * 100) if total > 0 else 0 }}%; {{ 'background-color: var(--danger-fg);' if rate < 50 else '' }}"></div>
        </div>
        <span style="width: 30px; text-align: right; font-size: 0.85rem;">{{ count }}</span>
    </div>
    {% endfor %}
</div>

<div class="card card-p mb-6">
    <h3 class="card-title text-primary text-sm mt-0 mb-4">ìœ í˜•ë³„ ìƒíƒœ ìƒì„¸</h3>
    <div style="overflow-x: auto;">
        <table class="w-full" style="font-size: 0.85rem;">
            <thead>
                <tr>
                    <th style="background: transparent; padding-left: 4px;">ìœ í˜•</th>
                    <th class="text-center" style="background: transparent;">ëŒ€ê¸°</th>
                    <th class="text-center" style="background: transparent;">ì§„í–‰</th>
                    <th class="text-center" style="background: transparent;">ì™„ë£Œ</th>
                    <th class="text-center" style="background: transparent;">ë§Œë£Œ</th>
                    <th class="text-center" style="background: transparent;">í¬ê¸°</th>
                    <th class="text-right" style="background: transparent;">ì™„ë£Œìœ¨</th>
                    <th class="text-right" style="background: transparent; padding-right: 4px;">í•©ê³„</th>
                </tr>
            </thead>
            <tbody>
                {% for type_name in type_counts.keys() %}
                {% set s_counts = type_status_counts.get(type_name, {}) %}
                {% set rate = type_rates.get(type_name, 0) %}
                <tr>
                    <td class="font-bold" style="padding-left: 4px;">{{ type_name }}</td>
                    <td class="text-center text-sub">{{ s_counts.get('pending', 0) }}</td>
                    <td class="text-center text-primary">{{ s_counts.get('in_progress', 0) }}</td>
                    <td class="text-center text-success">{{ s_counts.get('completed', 0) }}</td>
                    <td class="text-center text-danger">{{ s_counts.get('expired', 0) }}</td>
                    <td class="text-center text-muted">{{ s_counts.get('given_up', 0) }}</td>
                    <td class="text-right font-bold {{ 'text-danger' if rate < 50 else 'text-primary' }}">{{ "%.1f"|format(rate) }}%</td>
                    <td class="text-right font-bold" style="padding-right: 4px;">{{ type_counts.get(type_name, 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{{ filter_form([
    {"type": "select", "name": "status_filter", "value": status_filter, "options": [
        {"value": "", "label": "ì „ì²´ ìƒíƒœ"},
        {"value": "pending", "label": "ëŒ€ê¸° (pending)"},
        {"value": "in_progress", "label": "ì§„í–‰ (in_progress)"},
        {"value": "completed", "label": "ì™„ë£Œ (completed)"},
        {"value": "expired", "label": "ë§Œë£Œ (expired)"},
        {"value": "given_up", "label": "í¬ê¸° (given_up)"}
    ]},
    {"type": "select", "name": "type_filter", "value": type_filter, "options": [
        {"value": "", "label": "ì „ì²´ ìœ í˜•"},
        {"value": "savings", "label": "savings (ì €ì¶•)"},
        {"value": "spending", "label": "spending (ì§€ì¶œ ì ˆê°)"},
        {"value": "credit", "label": "credit (ì‹ ìš© ê´€ë¦¬)"},
        {"value": "investment", "label": "investment (íˆ¬ì)"},
        {"value": "lifestyle", "label": "lifestyle (ìƒí™œ ìŠµê´€)"}
    ]},
    {"type": "select", "name": "difficulty_filter", "value": difficulty_filter, "options": [
        {"value": "", "label": "ì „ì²´ ë‚œì´ë„"},
        {"value": "easy", "label": "easy (ì‰¬ì›€)"},
        {"value": "medium", "label": "medium (ë³´í†µ)"},
        {"value": "hard", "label": "hard (ì–´ë ¤ì›€)"}
    ]}
], label="í•„í„°:", submit_label="ì ìš©", submit_class="btn-primary",
   reset_url="/missions", show_reset=status_filter or type_filter or difficulty_filter, extra_class="mb-4") }}

<form method="post" id="bulkForm">
    <input type="hidden" name="change_reason" id="hidden_change_reason">
    <input type="hidden" name="delete_reason" id="hidden_delete_reason">
    <div class="flex justify-between items-center mb-2">
        <div class="flex gap-2 items-center">
            <select name="new_status" id="new_status_select" class="form-select py-1 h-8 text-sm w-auto">
                <option value="">ìƒíƒœ ë³€ê²½...</option>
                <option value="pending">pending</option>
                <option value="in_progress">in_progress</option>
                <option value="completed">completed</option>
                <option value="expired">expired</option>
                <option value="given_up">given_up</option>
            </select>
            <button type="button" onclick="openBulkUpdateModal()" class="btn-tonal btn-sm">ì¼ê´„ ë³€ê²½</button>
        </div>
        <button type="button" onclick="openBulkDeleteModal()" class="btn-outline-danger btn-sm">ì„ íƒ ì‚­ì œ</button>
    </div>
    <div class="table-wrapper">
        <table class="w-full">
            <thead><tr>
                <th class="text-center" style="width: 40px;"><input type="checkbox" onclick="toggleAll(this)"></th>
            <th>ID</th>
            <th>ìœ ì €</th>
            <th>ë¯¸ì…˜ ì œëª©</th>
            <th>ìœ í˜•</th>
            <th>ëŒ€ì¶œ ëª©ì </th>
            <th>ìƒíƒœ</th>
            <th>
                <a href="{{ url_for('missions', sort_by='difficulty', order='desc' if sort_by == 'difficulty' and order == 'asc' else 'asc', status_filter=status_filter, type_filter=type_filter, difficulty_filter=difficulty_filter) }}" style="text-decoration: none; color: inherit;">
                    ë‚œì´ë„ {% if sort_by == 'difficulty' %}<span class="text-primary">{{ 'â–²' if order == 'asc' else 'â–¼' }}</span>{% endif %}
                </a>
            </th>
            <th>
                <a href="{{ url_for('missions', sort_by='reward_points', order='asc' if sort_by == 'reward_points' and order == 'desc' else 'desc', status_filter=status_filter, type_filter=type_filter, difficulty_filter=difficulty_filter) }}" style="text-decoration: none; color: inherit;">
                    í¬ì¸íŠ¸ {% if sort_by == 'reward_points' %}<span class="text-primary">{{ 'â–²' if order == 'asc' else 'â–¼' }}</span>{% endif %}
                </a>
            </th>
            <th>ë§ˆê°ì¼</th>
        </tr></thead>
        <tbody>
            {% for m in missions %}
            <tr>
                <td class="text-center"><input type="checkbox" name="mission_ids" value="{{ m.mission_id }}"></td>
                <td>{{ m.mission_id }}</td>
                <td>{{ m.user_id }}</td>
                <td class="font-bold">
                    <a href="/missions/{{ m.mission_id }}" class="text-primary" style="text-decoration: none;">{{ m.mission_title }}</a>
                </td>
                <td><span class="badge badge-info">{{ m.mission_type }}</span></td>
                <td>{{ m.loan_purpose or '-' }}</td>
                <td>
                    {{ status_badge(m.status) }}
                </td>
                <td>{{ m.difficulty }}</td>
                <td>{{ m.reward_points }}</td>
                <td>{{ m.due_date or '-' }}</td>
            </tr>
            {% else %}
            {{ empty_state(10, "ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.") }}
            {% endfor %}
        </tbody>
    </table>
</div>
</form>

{{ pagination(page, total_pages,
    url_for('missions', page=page-1, status_filter=status_filter, type_filter=type_filter, difficulty_filter=difficulty_filter, sort_by=sort_by, order=order),
    url_for('missions', page=page+1, status_filter=status_filter, type_filter=type_filter, difficulty_filter=difficulty_filter, sort_by=sort_by, order=order)) }}

<!-- Bulk Update Modal -->
<div id="bulkUpdateModal" class="modal-overlay hidden" onclick="if(event.target === this) closeBulkUpdateModal()">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>ì¼ê´„ ìƒíƒœ ë³€ê²½</h3>
            <button onclick="closeBulkUpdateModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p class="mb-4">ì„ íƒí•œ ë¯¸ì…˜ì˜ ìƒíƒœë¥¼ <span id="modalStatusDisplay" class="font-bold text-primary"></span>(ìœ¼)ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.</p>
            <div class="form-group">
                <label class="form-label">ë³€ê²½ ì‚¬ìœ  (History ê¸°ë¡)</label>
                <textarea id="modalReasonInput" class="form-textarea" rows="3" placeholder="ì˜ˆ: ì •ì±… ë³€ê²½ìœ¼ë¡œ ì¸í•œ ì¼ê´„ ì²˜ë¦¬"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeBulkUpdateModal()" class="btn-tonal">ì·¨ì†Œ</button>
                <button onclick="submitBulkUpdate()" class="btn-primary">ë³€ê²½ í™•ì •</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div id="bulkDeleteModal" class="modal-overlay hidden" onclick="if(event.target === this) closeBulkDeleteModal()">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="text-danger">ì¼ê´„ ì‚­ì œ</h3>
            <button onclick="closeBulkDeleteModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warn-banner mb-4">ì„ íƒí•œ ë¯¸ì…˜ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            <div class="form-group">
                <label class="form-label">ì‚­ì œ ì‚¬ìœ  (í•„ìˆ˜)</label>
                <textarea id="modalDeleteReasonInput" class="form-textarea" rows="3" placeholder="ì˜ˆ: ê¸°ê°„ ë§Œë£Œ ë°ì´í„° ì •ë¦¬"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeBulkDeleteModal()" class="btn-tonal">ì·¨ì†Œ</button>
                <button onclick="submitBulkDelete()" class="btn-outline-danger">ì‚­ì œ í™•ì •</button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleAll(source) {
    var checkboxes = document.getElementsByName('mission_ids');
    for(var i=0, n=checkboxes.length;i<n;i++) {
        checkboxes[i].checked = source.checked;
    }
}

function openBulkUpdateModal() {
    var statusSelect = document.getElementById('new_status_select');
    var selectedStatus = statusSelect.value;
    if (!selectedStatus) { alert('ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    var checkboxes = document.querySelectorAll('input[name="mission_ids"]:checked');
    if (checkboxes.length === 0) { alert('ë³€ê²½í•  ë¯¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    document.getElementById('modalStatusDisplay').textContent = selectedStatus;
    document.getElementById('bulkUpdateModal').classList.remove('hidden');
    document.getElementById('modalReasonInput').focus();
}
function closeBulkUpdateModal() { document.getElementById('bulkUpdateModal').classList.add('hidden'); }
function submitBulkUpdate() {
    var reason = document.getElementById('modalReasonInput').value;
    if (!reason.trim()) { alert('ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    document.getElementById('hidden_change_reason').value = reason;
    var form = document.getElementById('bulkForm');
    form.action = "/missions/bulk_update_status";
    form.submit();
}

function openBulkDeleteModal() {
    var checkboxes = document.querySelectorAll('input[name="mission_ids"]:checked');
    if (checkboxes.length === 0) { alert('ì‚­ì œí•  ë¯¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    document.getElementById('bulkDeleteModal').classList.remove('hidden');
    document.getElementById('modalDeleteReasonInput').focus();
}
function closeBulkDeleteModal() { document.getElementById('bulkDeleteModal').classList.add('hidden'); }
function submitBulkDelete() {
    var reason = document.getElementById('modalDeleteReasonInput').value;
    if (!reason.trim()) { alert('ì‚­ì œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    document.getElementById('hidden_delete_reason').value = reason;
    var form = document.getElementById('bulkForm');
    form.action = "/missions/bulk_delete";
    form.submit();
}
</script>
{% endblock %}