{% extends "base.html" %}
{% from "macros.html" import status_badge, empty_state %}
{% block content %}
<h1>미션 상세</h1>
<a href="/missions" class="nav-btn mb-4">목록으로 돌아가기</a>
<div class="info-banner">미션 상세 정보입니다. 이 페이지는 읽기 전용이며, 미션 상태는 시스템에 의해 자동으로 관리됩니다.</div>

<div class="card card-p">
    <div class="flex justify-between items-start mb-4">
        <h3 class="card-title text-primary mt-0">미션 정보</h3>
        {% if mission.status in ['pending', 'in_progress'] %}
        <form action="/missions/{{ mission.mission_id }}/complete" method="post" onsubmit="return confirm('미션을 강제 완료 처리하고 포인트를 지급하시겠습니까?');">
            <button type="submit" class="btn-primary btn-sm">미션 완료 처리 (포인트 지급)</button>
        </form>
        {% endif %}
    </div>
    <table class="w-full">
        <tr><td class="font-bold text-sub w-150">Mission ID</td><td>{{ mission.mission_id }}</td></tr>
        <tr><td class="font-bold text-sub">유저 ID</td><td>{{ mission.user_id }}</td></tr>
        <tr>
            <td class="font-bold text-sub">미션 제목</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_title" method="post" class="flex gap-2 items-center">
                    <input type="text" name="mission_title" value="{{ mission.mission_title }}" class="form-input py-1 h-8 text-sm w-full" required>
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">미션 설명</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_description" method="post" class="flex gap-2 items-start">
                    <textarea name="mission_description" class="form-textarea py-1 text-sm w-full" rows="2">{{ mission.mission_description or '' }}</textarea>
                    <button type="submit" class="btn-tonal btn-sm mt-1">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">유형</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_type" method="post" class="flex gap-2 items-center">
                    <select name="mission_type" class="form-select py-1 h-8 text-sm w-auto">
                        <option value="savings" {% if mission.mission_type == 'savings' %}selected{% endif %}>savings (저축)</option>
                        <option value="spending" {% if mission.mission_type == 'spending' %}selected{% endif %}>spending (지출)</option>
                        <option value="credit" {% if mission.mission_type == 'credit' %}selected{% endif %}>credit (신용)</option>
                        <option value="investment" {% if mission.mission_type == 'investment' %}selected{% endif %}>investment (투자)</option>
                        <option value="lifestyle" {% if mission.mission_type == 'lifestyle' %}selected{% endif %}>lifestyle (생활)</option>
                    </select>
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">자동 달성 조건</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_tracking" method="post" class="flex gap-2 items-center flex-wrap">
                    <select name="tracking_key" class="form-select py-1 h-8 text-sm w-auto">
                        <option value="">(없음)</option>
                        <option value="credit_score" {% if mission.tracking_key == 'credit_score' %}selected{% endif %}>credit_score (신용점수)</option>
                        <option value="dsr" {% if mission.tracking_key == 'dsr' %}selected{% endif %}>dsr (DSR)</option>
                        <option value="cardUsageRate" {% if mission.tracking_key == 'cardUsageRate' %}selected{% endif %}>cardUsageRate (카드사용률)</option>
                        <option value="delinquency" {% if mission.tracking_key == 'delinquency' %}selected{% endif %}>delinquency (연체)</option>
                        <option value="salaryTransfer" {% if mission.tracking_key == 'salaryTransfer' %}selected{% endif %}>salaryTransfer (급여이체)</option>
                        <option value="highInterestLoan" {% if mission.tracking_key == 'highInterestLoan' %}selected{% endif %}>highInterestLoan (고금리대출)</option>
                        <option value="minusLimit" {% if mission.tracking_key == 'minusLimit' %}selected{% endif %}>minusLimit (마이너스통장)</option>
                        <option value="openBanking" {% if mission.tracking_key == 'openBanking' %}selected{% endif %}>openBanking (오픈뱅킹)</option>
                        <option value="checkedCredit" {% if mission.tracking_key == 'checkedCredit' %}selected{% endif %}>checkedCredit (신용조회)</option>
                        <option value="checkedMembership" {% if mission.tracking_key == 'checkedMembership' %}selected{% endif %}>checkedMembership (멤버십확인)</option>
                    </select>
                    <select name="tracking_operator" class="form-select py-1 h-8 text-sm w-auto">
                        <option value="">(연산자)</option>
                        <option value="eq" {% if mission.tracking_operator == 'eq' %}selected{% endif %}>= (일치)</option>
                        <option value="gte" {% if mission.tracking_operator == 'gte' %}selected{% endif %}>&gt;= (이상)</option>
                        <option value="lte" {% if mission.tracking_operator == 'lte' %}selected{% endif %}>&lt;= (이하)</option>
                        <option value="gt" {% if mission.tracking_operator == 'gt' %}selected{% endif %}>&gt; (초과)</option>
                        <option value="lt" {% if mission.tracking_operator == 'lt' %}selected{% endif %}>&lt; (미만)</option>
                    </select>
                    <input type="number" step="0.1" name="tracking_value" value="{{ mission.tracking_value }}" class="form-input py-1 h-8 text-sm w-auto" style="width: 80px;" placeholder="값">
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">대출 목적</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_purpose" method="post" class="flex gap-2 items-center">
                    <input type="text" name="loan_purpose" value="{{ mission.loan_purpose or '' }}" class="form-input py-1 h-8 text-sm w-auto" placeholder="예: 생활안정자금">
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">상태</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_status" method="post" class="flex gap-2 items-center">
                    <select name="status" class="form-select py-1 h-8 text-sm w-auto">
                        <option value="pending" {% if mission.status == 'pending' %}selected{% endif %}>pending (대기)</option>
                        <option value="in_progress" {% if mission.status == 'in_progress' %}selected{% endif %}>in_progress (진행)</option>
                        <option value="completed" {% if mission.status == 'completed' %}selected{% endif %}>completed (완료)</option>
                        <option value="expired" {% if mission.status == 'expired' %}selected{% endif %}>expired (만료)</option>
                        <option value="given_up" {% if mission.status == 'given_up' %}selected{% endif %}>given_up (포기)</option>
                    </select>
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">난이도</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_difficulty" method="post" class="flex gap-2 items-center">
                    <select name="difficulty" class="form-select py-1 h-8 text-sm w-auto">
                        <option value="easy" {% if mission.difficulty == 'easy' %}selected{% endif %}>easy</option>
                        <option value="medium" {% if mission.difficulty == 'medium' %}selected{% endif %}>medium</option>
                        <option value="hard" {% if mission.difficulty == 'hard' %}selected{% endif %}>hard</option>
                    </select>
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">보상 포인트</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_reward" method="post" class="flex gap-2 items-center">
                    <input type="number" name="reward_points" value="{{ mission.reward_points }}" class="form-input py-1 h-8 text-sm w-auto" style="width: 100px;">
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr>
            <td class="font-bold text-sub">마감일</td>
            <td>
                <form action="/missions/{{ mission.mission_id }}/update_duedate" method="post" class="flex gap-2 items-center">
                    <input type="date" name="due_date" value="{{ mission.due_date }}" class="form-input py-1 h-8 text-sm w-auto">
                    <button type="submit" class="btn-tonal btn-sm">변경</button>
                </form>
            </td>
        </tr>
        <tr><td class="font-bold text-sub">완료일</td><td>{{ mission.completed_at or '-' }}</td></tr>
        <tr><td class="font-bold text-sub">생성일</td><td>{{ mission.created_at }}</td></tr>
    </table>
</div>

<div class="card card-p mt-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="card-title text-primary mt-0">동일 미션 수행 유저 ({{ related_users|length }}명)</h3>
        <a href="/missions/{{ mission.mission_id }}/download_related" class="btn-tonal btn-sm" title="목록을 CSV로 다운로드">CSV 다운로드</a>
    </div>
    <div class="table-wrapper">
        <table class="w-full">
            <thead><tr>
                <th>User ID</th>
                <th class="text-center">상태</th>
                <th>시작일</th>
                <th>완료일</th>
                <th class="text-center">상세</th>
            </tr></thead>
            <tbody>
                {% for u in related_users %}
                <tr class="{{ 'bg-soft' if u.mission_id == mission.mission_id else '' }}">
                    <td class="font-bold">{{ u.user_id }}</td>
                    <td class="text-center">{{ status_badge(u.status) }}</td>
                    <td>{{ u.created_at }}</td>
                    <td>{{ u.completed_at or '-' }}</td>
                    <td class="text-center">
                        {% if u.mission_id != mission.mission_id %}
                        <a href="/missions/{{ u.mission_id }}" class="btn-tonal btn-sm">이동</a>
                        {% else %}
                        <span class="text-xs text-muted">현재 보고중</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                {{ empty_state(5, "수행 중인 다른 유저가 없습니다.") }}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card card-p mt-6">
    <h3 class="card-title text-primary mt-0 mb-4">변경 이력 (History)</h3>
    <div class="table-wrapper">
        <table class="w-full">
            <thead><tr>
                <th>일시</th>
                <th>관리자</th>
                <th>유형</th>
                <th>내용</th>
            </tr></thead>
            <tbody>
                {% for h in history %}
                <tr>
                    <td class="text-sub">{{ h.created_at }}</td>
                    <td>{{ h.admin_id }}</td>
                    <td><span class="badge badge-neutral">{{ h.change_type }}</span></td>
                    <td>{{ h.description }}</td>
                </tr>
                {% else %}
                {{ empty_state(4, "변경 이력이 없습니다.") }}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card card-p mt-6 border-danger">
    <h3 class="card-title text-danger text-sm mt-0 mb-3">미션 삭제</h3>
    <div class="warn-banner">삭제된 미션은 복구할 수 없습니다.</div>
    <form action="/missions/{{ mission.mission_id }}/delete" method="post" onsubmit="return confirm('정말 이 미션을 삭제하시겠습니까?');">
        <button type="submit" class="w-full btn-outline-danger">미션 삭제</button>
    </form>
</div>
{% endblock %}