{% extends "base.html" %}
{% block content %}
<h1>금융 데이터 수집 관리</h1>

<div class="card guide-card">
    <div class="card-p">
        <div class="flex items-center gap-2 mb-2">
            <span class="badge badge-info">설계 의도</span>
            <h3 class="font-bold text-sm">데이터 수집의 투명성</h3>
        </div>
        <p class="text-sm text-sub">
            신뢰할 수 있는 AI는 신뢰할 수 있는 데이터에서 시작됩니다. 이 페이지에서는 <strong>금융감독원(대출상품), 통계청(소득/경제지표)</strong> 등 공신력 있는 외부 기관의 데이터를 수집하는 파이프라인을 관리합니다. <br>각 데이터 소스별로 수집 상태를 모니터링하고 제어함으로써, AI 모델이 학습하고 추론하는 데이터의 <strong>최신성과 무결성</strong>을 보장합니다.
        </p>
    </div>
</div>

<div class="info-banner">데이터 수집 소스별로 자동 수집 활성화 여부를 설정하고, 필요 시 데이터를 즉시 새로고침(수집)할 수 있습니다. OFF 상태에서는 자동 스케줄 수집이 실행되지 않으며, 새로고침 버튼도 비활성화됩니다.</div>

<div class="dashboard-grid">
    {% for src in sources %}
    <div class="card card-p">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 class="card-title text-lg mb-1">{{ src.label }}</h3>
                <p class="text-xs text-muted">{{ src.api_desc }}</p>
            </div>
            <form action="/toggle_collector" method="post" style="margin:0;">
                <input type="hidden" name="source" value="{{ src.key }}">
                <label class="toggle-switch" title="{{ '클릭하여 비활성화' if src.enabled else '클릭하여 활성화' }}" style="z-index: 20; position: relative;">
                    <input type="checkbox" onchange="this.form.submit()" {{ 'checked' if src.enabled else '' }}>
                    <span class="slider"></span>
                </label>
            </form>
        </div>
        
        <!-- Status Grid -->
        <div class="grid-3 gap-4 mb-6 p-4 bg-soft rounded-xl border border-light">
            <div class="flex flex-col gap-1">
                <span class="text-xs text-muted font-medium uppercase tracking-wider">상태</span>
                <div class="flex items-center gap-2">
                    <span class="badge {{ 'badge-success' if src.last_status == 'SUCCESS' else 'badge-danger' if src.last_status == 'FAIL' else 'badge-neutral' }}">{{ src.last_status or '-' }}</span>
                    <form action="/trigger" method="post" class="inline-flex">
                        <button type="submit" name="job" value="{{ src.trigger_val }}" title="데이터 새로고침" class="btn-icon p-1 hover:bg-white rounded-full {{ 'opacity-50 cursor-not-allowed' if not src.enabled else '' }}" {{ 'disabled' if not src.enabled else '' }} style="width: 24px; height: 24px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                        </button>
                    </form>
                </div>
            </div>
            <div class="flex flex-col gap-1">
                <span class="text-xs text-muted font-medium uppercase tracking-wider">최근 실행</span>
                <span class="text-sm font-bold text-main font-mono">{{ src.last_run }}</span>
            </div>
            <div class="flex flex-col gap-1">
                <span class="text-xs text-muted font-medium uppercase tracking-wider">누적 데이터</span>
                <span class="text-sm font-bold text-primary font-mono">{{ src.total_count }}</span>
            </div>
        </div>

        <!-- Configuration -->
        <form action="/collection-management/config" method="post" class="space-y-4">
            <div>
                <label class="form-label text-xs uppercase text-muted mb-2">API Key</label>
                <div class="relative">
                    <input type="password" id="input_{{ src.key }}" name="{{ src.api_field }}" value="{{ src.api_value }}" placeholder="인증키를 입력하세요" class="form-input text-sm w-full font-mono bg-soft pr-10 border-transparent focus:bg-white focus:border-primary transition-colors">
                    <span onclick="togglePassword('input_{{ src.key }}', this)" class="absolute right-3 top-50p translate-y-50n cursor-pointer text-muted hover:text-primary transition-colors" title="키 보기/숨기기">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </span>
                </div>
            </div>
            
            <div class="grid-2 gap-4">
                <div>
                    <label class="form-label text-xs uppercase text-muted mb-2">수집 주기</label>
                    <div class="radio-group">
                        {% set f_val = src.freq_value %}
                        {% set freq_options = [('daily', '매일'), ('weekly', '매주'), ('monthly', '매월')] %}
                        
                        {% for val, label in freq_options %}
                        <label class="radio-chip">
                            <input type="radio" name="{{ src.freq_field }}" value="{{ val }}" 
                                   {% if f_val == val %}checked{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <label class="form-label text-xs uppercase text-muted mb-2">수집 기간</label>
                    <div class="radio-group">
                        {% set p_val = src.period_value | int %}
                        {% set options = [(0, '전체'), (1, '1개월'), (3, '3개월'), (6, '6개월'), (12, '1년')] %}
                        {% set is_custom = p_val not in [0, 1, 3, 6, 12] %}
                        
                        {% for val, label in options %}
                        <label class="radio-chip">
                            <input type="radio" name="{{ src.period_field }}_opt" value="{{ val }}" 
                                   onchange="togglePeriodInput(this, '{{ src.period_field }}')"
                                   {% if p_val == val %}checked{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                        {% endfor %}
                        
                        <label class="radio-chip">
                            <input type="radio" name="{{ src.period_field }}_opt" value="custom" 
                                   onchange="togglePeriodInput(this, '{{ src.period_field }}')"
                                   {% if is_custom %}checked{% endif %}>
                            <span>기타</span>
                        </label>
                    </div>
                    <input type="number" id="{{ src.period_field }}" name="{{ src.period_field }}" value="{{ src.period_value }}" min="0" max="60" class="form-input text-sm w-full mt-2" style="{{ 'display:none;' if not is_custom else '' }}" placeholder="개월 수 입력">
                </div>
            </div>

            <div class="flex justify-end pt-2">
                <button type="submit" class="nav-btn bg-white border border-border hover:bg-soft hover:border-primary text-sub hover:text-primary transition-all shadow-sm" style="padding: 8px 20px; font-size: 0.85rem;">
                    설정 저장
                </button>
            </div>
        </form>

        {% if not src.enabled %}
        <div class="absolute inset-0 bg-white/50 backdrop-blur-[1px] z-10 flex items-center justify-center rounded-2xl pointer-events-none">
            <div class="bg-white/90 px-4 py-2 rounded-lg shadow-sm border border-light text-danger font-bold text-sm">
                수집 비활성화됨
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<script>
function togglePeriodInput(radio, targetId) {
    var input = document.getElementById(targetId);
    if (radio.value === 'custom') {
        input.style.display = 'block';
        input.focus();
    } else {
        input.style.display = 'none';
        input.value = radio.value;
    }
}
function togglePassword(inputId, iconSpan) {
    var input = document.getElementById(inputId);
    if (input.type === "password") {
        input.type = "text";
        iconSpan.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
    } else {
        input.type = "password";
        iconSpan.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
    }
}
</script>
{% endblock %}