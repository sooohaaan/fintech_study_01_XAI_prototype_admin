{% extends "base.html" %}
{% from "macros.html" import guide_card, empty_state, pagination %}
{% block content %}
    <h1>수집 데이터 조회: {{ table_name }}</h1>

    {{ guide_card("데이터 접근성", "원시 데이터(Raw Data) 조회",
        "AI 모델 학습과 서비스 운영에 사용되는 실제 데이터를 직접 조회하여 데이터 파이프라인의 신뢰성을 검증합니다.",
        [
            {"title": "테이블 선택", "desc": "상단 탭에서 조회할 데이터 테이블을 선택합니다."},
            {"title": "데이터 조회", "desc": "필터 조건을 설정하고 원시 데이터를 조회합니다."}
        ]) }}
    <div class="mb-4 flex flex-wrap gap-2">
        <a href="/data/raw_loan_products" class="nav-btn {{ 'active' if table_name == 'raw_loan_products' else '' }}">대출 상품</a>
        <a href="/data/raw_economic_indicators" class="nav-btn {{ 'active' if table_name == 'raw_economic_indicators' else '' }}">경제 지표</a>
        <a href="/data/raw_income_stats" class="nav-btn {{ 'active' if table_name == 'raw_income_stats' else '' }}">소득 통계</a>
        <a href="/data/collection_logs" class="nav-btn {{ 'active' if table_name == 'collection_logs' else '' }}">수집 로그</a>
        <a href="/data/missions" class="nav-btn {{ 'active' if table_name == 'missions' else '' }}">미션</a>
        <a href="/data/user_points" class="nav-btn {{ 'active' if table_name == 'user_points' else '' }}">유저 포인트</a>
        <a href="/data/point_transactions" class="nav-btn {{ 'active' if table_name == 'point_transactions' else '' }}">포인트 거래</a>
        <a href="/data/point_products" class="nav-btn {{ 'active' if table_name == 'point_products' else '' }}">포인트 상품</a>
        <a href="/data/point_purchases" class="nav-btn {{ 'active' if table_name == 'point_purchases' else '' }}">포인트 구매</a>
        <a href="/data/users" class="nav-btn {{ 'active' if table_name == 'users' else '' }}">회원</a>
        <a href="/data/notifications" class="nav-btn {{ 'active' if table_name == 'notifications' else '' }}">알림</a>
    </div>
    <form method="get" action="{{ url_for('view_data', table_name=table_name) }}" class="mb-4 bg-soft rounded-lg flex gap-2 items-center flex-wrap p-4">
        <span class="font-semibold text-sub">검색:</span>
        <select name="search_col" class="form-select w-auto">
            {% for col in columns %}<option value="{{ col }}" {% if search_col == col %}selected{% endif %}>{{ col }}</option>{% endfor %}
        </select>
        <input type="text" name="search_val" value="{{ search_val if search_val else '' }}" placeholder="검색어 입력" class="form-input flex-1 min-w-200">
        <button type="submit" class="btn-accent">검색</button>
        {% if search_val %}<a href="{{ url_for('view_data', table_name=table_name) }}" class="nav-btn">초기화</a>{% endif %}
    </form>
    <div class="table-wrapper">
        <table class="w-full">
            <thead><tr>
                {% for col in columns %}
                <th class="nowrap {% if sort_by == col %}bg-soft{% endif %}">
                    <a href="{{ url_for('view_data', table_name=table_name, page=1, sort_by=col, order='desc' if sort_by == col and order == 'asc' else 'asc', search_col=search_col, search_val=search_val) }}" style="text-decoration: none; color: inherit; display: flex; align-items: center; justify-content: flex-start; gap: 4px;">
                        <span class="{% if sort_by == col %}text-primary font-bold{% endif %}">{{ col }}</span>
                        {% if sort_by == col %}
                            {% if order == 'asc' %}
                                <svg style="width: 0.8rem; height: 0.8rem;" class="text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                            {% else %}
                                <svg style="width: 0.8rem; height: 0.8rem;" class="text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            {% endif %}
                        {% endif %}
                    </a>
                </th>
                {% endfor %}
            </tr></thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    {% for col in columns %}
                    <td>
                        {% if col in ['status', 'type', 'transaction_type', 'product_type'] %}
                            <span class="badge badge-neutral">{{ row[col] }}</span>
                        {% elif col in ['message', 'error_message', 'description', 'memo', 'reason', 'api_desc'] and row[col] %}
                            <div class="text-truncate" style="max-width: 300px; cursor: pointer; color: var(--text-main);" 
                                 onclick="showLogMessage(this.getAttribute('data-msg'))" 
                                 data-msg="{{ row[col] }}" title="클릭하여 전체 보기">
                                {{ row[col] }}
                            </div>
                        {% else %}
                            {{ row[col] }}
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% else %}{{ empty_state(columns|length, "데이터가 없습니다.") }}{% endfor %}
            </tbody>
        </table>
    </div>
    {{ pagination(page, total_pages,
        url_for('view_data', table_name=table_name, page=page-1, sort_by=sort_by, order=order, search_col=search_col, search_val=search_val),
        url_for('view_data', table_name=table_name, page=page+1, sort_by=sort_by, order=order, search_col=search_col, search_val=search_val),
        "{:,}".format(total_count)) }}
{% endblock %}