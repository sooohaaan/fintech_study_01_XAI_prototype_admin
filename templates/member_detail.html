{% extends "base.html" %}
{% block content %}
<h1>회원 상세 정보</h1>
<a href="/members" class="nav-btn mb-4">목록으로 돌아가기</a>
<div class="info-banner">회원의 기본 정보, 포인트 현황, 미션 현황, 포인트 구매 내역을 통합 조회합니다.</div>

<div class="grid-2-1 mb-6">
    <div class="card card-p">
        <div class="flex justify-between items-center mb-4">
            <h3 class="card-title text-primary mt-0">기본 정보</h3>
            <a href="/members/{{ user.user_id }}/edit" class="nav-btn" style="padding: 6px 16px; font-size: 0.85rem;">수정</a>
        </div>
        <table class="w-full">
            <tr><td class="font-bold text-sub w-120">회원 ID</td><td style="font-family: monospace;">{{ user.user_id }}</td></tr>
            <tr class="bg-soft"><td class="font-bold text-sub">이름</td><td>{{ user.user_name }}</td></tr>
            <tr><td class="font-bold text-sub">이메일</td><td>{{ user.email or '-' }}</td></tr>
            <tr class="bg-soft"><td class="font-bold text-sub">전화번호</td><td>{{ user.phone or '-' }}</td></tr>
            <tr><td class="font-bold text-sub">가입일</td><td>{{ user.join_date or '-' }}</td></tr>
            <tr class="bg-soft"><td class="font-bold text-sub">메모</td><td>{{ user.memo or '-' }}</td></tr>
        </table>
    </div>

    <div class="flex flex-col gap-4">
        <div class="card card-p">
            <h3 class="card-title text-primary text-sm mt-0 mb-4">현재 상태</h3>
            <div style="text-align: center; margin-bottom: 1rem;">
                {% if user.status == 'active' %}
                    <span class="badge badge-success badge-lg">활성</span>
                {% elif user.status == 'suspended' %}
                    <span class="badge badge-danger badge-lg">정지</span>
                {% else %}
                    <span class="badge badge-neutral badge-lg">탈퇴</span>
                {% endif %}
            </div>
            <form action="/members/{{ user.user_id }}/status" method="post" class="flex gap-2">
                <select name="new_status" class="form-select flex-1">
                    <option value="active" {% if user.status == 'active' %}selected{% endif %}>활성</option>
                    <option value="suspended" {% if user.status == 'suspended' %}selected{% endif %}>정지</option>
                    <option value="withdrawn" {% if user.status == 'withdrawn' %}selected{% endif %}>탈퇴</option>
                </select>
                <button type="submit" class="btn-accent" style="padding: 8px 16px; background-color: var(--warning-fg);">변경</button>
            </form>
        </div>
        <div class="card card-p border-danger">
            <h3 class="card-title text-danger text-sm mt-0 mb-3">회원 삭제</h3>
            <div class="warn-banner">삭제된 회원은 복구할 수 없습니다.</div>
            <form action="/members/{{ user.user_id }}/delete" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                <button type="submit" class="w-full btn-outline-danger" style="padding: 10px;">회원 삭제</button>
            </form>
        </div>
    </div>
</div>

<div class="summary-grid mb-6">
    <div class="summary-card">
        <div class="summary-label">포인트 잔액</div>
        <div class="summary-value">{{ "{:,}".format(points.balance) }}P</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">총 지급</div>
        <div class="summary-value text-success">{{ "{:,}".format(points.total_earned) }}P</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">총 사용</div>
        <div class="summary-value text-danger">{{ "{:,}".format(points.total_spent) }}P</div>
    </div>
</div>

<div class="card card-p mb-6">
    <h3 class="card-title text-primary mt-0 mb-4">미션 현황 ({{ missions|length }}건)</h3>
    {% if missions %}
    <div style="overflow-x: auto;">
        <table class="w-full">
            <thead><tr>
                <th>미션명</th>
                <th>유형</th>
                <th class="text-center">상태</th>
                <th class="text-right">보상 포인트</th>
                <th>마감일</th>
            </tr></thead>
            <tbody>
                {% for m in missions %}
                <tr>
                    <td class="font-bold">{{ m.mission_title }}</td>
                    <td><span class="badge badge-info">{{ m.mission_type }}</span></td>
                    <td class="text-center">
                        {% if m.status == 'completed' %}
                            <span class="badge badge-success">완료</span>
                        {% elif m.status == 'in_progress' %}
                            <span class="badge badge-info">진행중</span>
                        {% elif m.status == 'expired' %}
                            <span class="badge badge-danger">만료</span>
                        {% else %}
                            <span class="badge badge-warning">대기</span>
                        {% endif %}
                    </td>
                    <td class="text-right font-bold">{{ "{:,}".format(m.reward_points) }}P</td>
                    <td>{{ m.due_date or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-muted p-4">미션 내역이 없습니다.</p>
    {% endif %}
</div>

<div class="card card-p">
    <h3 class="card-title text-primary mt-0 mb-4">포인트 구매 내역 ({{ purchases|length }}건)</h3>
    {% if purchases %}
    <div style="overflow-x: auto;">
        <table class="w-full">
            <thead><tr>
                <th>상품명</th>
                <th class="text-right">사용 포인트</th>
                <th class="text-center">상태</th>
                <th>구매일</th>
            </tr></thead>
            <tbody>
                {% for p in purchases %}
                <tr>
                    <td class="font-bold">{{ p.product_name or '(삭제된 상품)' }}</td>
                    <td class="text-right font-bold">{{ "{:,}".format(p.point_cost) }}P</td>
                    <td class="text-center">
                        {% if p.status == 'completed' %}
                            <span class="badge badge-success">completed</span>
                        {% elif p.status == 'cancelled' %}
                            <span class="badge badge-neutral">cancelled</span>
                        {% else %}
                            <span class="badge badge-warning">{{ p.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ p.purchased_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-muted p-4">구매 내역이 없습니다.</p>
    {% endif %}
</div>
{% endblock %}