{% extends "base.html" %}
{% from "macros.html" import summary_grid, status_badge, info_banner, warn_banner, confirm_form %}
{% block content %}
<h1>회원 상세 정보</h1>
<a href="/members" class="nav-btn mb-4">목록으로 돌아가기</a>
{{ info_banner("회원의 기본 정보, 포인트 현황, 미션 현황, 포인트 구매 내역을 통합 조회합니다.") }}

<div class="grid-2-1 mb-6">
    <div class="card card-p">
        <div class="flex justify-between items-center mb-4">
            <h3 class="card-title text-primary mt-0">기본 정보</h3>
            <a href="/members/{{ user.user_id }}/edit" class="btn-tonal btn-sm">수정</a>
        </div>
        <table class="w-full">
            <tr><td class="font-bold text-sub w-120">회원 ID</td><td style="font-family: monospace;">{{ user.user_id }}</td></tr>
            <tr class="bg-soft"><td class="font-bold text-sub">이름</td><td>{{ user.user_name }}</td></tr>
            <tr><td class="font-bold text-sub">이메일</td><td>{{ user.email or '-' }}</td></tr>
            <tr class="bg-soft"><td class="font-bold text-sub">전화번호</td><td>{{ user.phone or '-' }}</td></tr>
            <tr><td class="font-bold text-sub">가입일</td><td>{{ user.join_date or '-' }}</td></tr>
            <tr class="bg-soft"><td class="font-bold text-sub">메모</td><td>{{ user.memo or '-' }}</td></tr>
        </table>
    </div>

    <div class="flex flex-col gap-4">
        <div class="card card-p">
            <h3 class="card-title text-primary text-sm mt-0 mb-4">현재 상태</h3>
            <div style="text-align: center; margin-bottom: 1rem;">
                {{ status_badge(user.status, "user", "badge-lg") }}
            </div>
            <form action="/members/{{ user.user_id }}/status" method="post" class="flex gap-2">
                <select name="new_status" class="form-select flex-1">
                    <option value="active" {% if user.status == 'active' %}selected{% endif %}>활성</option>
                    <option value="suspended" {% if user.status == 'suspended' %}selected{% endif %}>정지</option>
                    <option value="withdrawn" {% if user.status == 'withdrawn' %}selected{% endif %}>탈퇴</option>
                </select>
                <button type="submit" class="btn-tonal">변경</button>
            </form>
        </div>
        <div class="card card-p border-danger">
            <h3 class="card-title text-danger text-sm mt-0 mb-3">회원 삭제</h3>
            {{ warn_banner("삭제된 회원은 복구할 수 없습니다.") }}
            {{ confirm_form("/members/" ~ user.user_id ~ "/delete", "회원 삭제") }}
        </div>
    </div>
</div>

{{ summary_grid([
    {"label": "포인트 잔액", "value": "{:,}".format(points.balance) ~ "P"},
    {"label": "총 지급", "value": "{:,}".format(points.total_earned) ~ "P", "color": "success"},
    {"label": "총 사용", "value": "{:,}".format(points.total_spent) ~ "P", "color": "danger"}
], "mb-6", title="포인트 현황", badge="Points") }}

<div class="card card-p mb-6">
    <h3 class="card-title text-primary mt-0 mb-4">미션 현황 ({{ missions|length }}건)</h3>
    {% if missions %}
    <div style="overflow-x: auto;">
        <table class="w-full">
            <thead><tr>
                <th>미션명</th>
                <th>유형</th>
                <th class="text-center">상태</th>
                <th class="text-right">보상 포인트</th>
                <th>마감일</th>
            </tr></thead>
            <tbody>
                {% for m in missions %}
                <tr>
                    <td class="font-bold">{{ m.mission_title }}</td>
                    <td><span class="badge badge-info">{{ m.mission_type }}</span></td>
                    <td class="text-center">{{ status_badge(m.status, "mission_ko") }}</td>
                    <td class="text-right font-bold">{{ "{:,}".format(m.reward_points) }}P</td>
                    <td>{{ m.due_date or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-muted p-4">미션 내역이 없습니다.</p>
    {% endif %}
</div>

<div class="card card-p">
    <h3 class="card-title text-primary mt-0 mb-4">포인트 구매 내역 ({{ purchases|length }}건)</h3>
    {% if purchases %}
    <div style="overflow-x: auto;">
        <table class="w-full">
            <thead><tr>
                <th>상품명</th>
                <th class="text-right">사용 포인트</th>
                <th class="text-center">상태</th>
                <th>구매일</th>
            </tr></thead>
            <tbody>
                {% for p in purchases %}
                <tr>
                    <td class="font-bold">{{ p.product_name or '(삭제된 상품)' }}</td>
                    <td class="text-right font-bold">{{ "{:,}".format(p.point_cost) }}P</td>
                    <td class="text-center">{{ status_badge(p.status, "purchase") }}</td>
                    <td>{{ p.purchased_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-muted p-4">구매 내역이 없습니다.</p>
    {% endif %}
</div>
{% endblock %}