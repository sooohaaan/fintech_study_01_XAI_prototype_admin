{% extends "base.html" %}

{% block head_meta %}
    {% if auto_refresh %}
    <meta http-equiv="refresh" content="30; url={{ url_for('index') }}">
    {% endif %}
{% endblock %}

{% block content %}
        <!-- Educational Guide Card -->
        <div class="card guide-card">
            <div class="card-p">
                <div class="flex items-center gap-2 mb-2">
                    <span class="badge badge-info">Dashboard Guide</span>
                    <h3 class="font-bold text-sm">통합 관제 대시보드</h3>
                </div>
                <div class="text-sm text-sub space-y-2">
                    <p><strong>목적:</strong> 서비스의 전반적인 건강 상태(Health)와 핵심 지표를 한눈에 파악합니다.</p>
                    <p><strong>기능:</strong>
                        1. <strong>시스템 상태:</strong> DB 연결 및 수집기 활성 상태 모니터링.<br>
                        2. <strong>데이터 요약:</strong> 수집된 금융 데이터의 총량 확인.<br>
                        3. <strong>수집 로그:</strong> 각 데이터 소스별 최근 실행 결과(성공/실패) 및 에러 확인.
                    </p>
                </div>
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-card" title="금감원 API에서 수집된 대출 상품의 총 건수입니다.">
                <div class="summary-label">대출 상품 수</div>
                <div class="summary-value">{{ "{:,}".format(stats.loan_count | default(0)) }}</div>
            </div>
            <div class="summary-card" title="통계청에서 수집된 경제 지표(금리, 물가 등)의 총 건수입니다.">
                <div class="summary-label">경제 지표 수</div>
                <div class="summary-value">{{ "{:,}".format(stats.economy_count | default(0)) }}</div>
            </div>
            <div class="summary-card" title="통계청 KOSIS에서 수집된 소득 통계의 총 건수입니다.">
                <div class="summary-label">소득 통계 수</div>
                <div class="summary-value">{{ "{:,}".format(stats.income_count | default(0)) }}</div>
            </div>
            <div class="summary-card" title="모든 데이터 소스의 수집 실행 기록(성공/실패 포함)의 총 건수입니다.">
                <div class="summary-label">총 수집 로그</div>
                <div class="summary-value">{{ "{:,}".format(stats.log_count | default(0)) }}</div>
            </div>
        </div>

        <div class="grid-2 mb-6">
            <!-- 신용 평가 가중치 요약 -->
            <div class="card h-fit">
                <div class="card-header">
                    <h3 class="card-title">현재 신용 평가 가중치</h3>
                    <a href="/credit-weights" class="btn-tonal" title="신용평가 가중치 상세 설정 페이지로 이동합니다.">설정 변경</a>
                </div>
                <div class="card-p">
                    <p class="help-text mb-3">세 가중치의 합은 1.0이어야 합니다.</p>
                    <div class="credit-weights-body">
                       <div class="weight-item">
                           <div class="weight-label">소득 비중</div>
                           <div class="weight-value text-primary" title="WEIGHT_INCOME">{{ stats.WEIGHT_INCOME | default(0.5) }}</div>
                        </div>
                        <div class="weight-item middle">
                            <div class="weight-label">고용 안정성</div>
                            <div class="weight-value text-secondary" title="WEIGHT_JOB_STABILITY">{{ stats.WEIGHT_JOB_STABILITY | default(0.3) }}</div>
                        </div>
                        <div class="weight-item">
                            <div class="weight-label">자산 비중</div>
                            <div class="weight-value text-tertiary" title="WEIGHT_ESTATE_ASSET">{{ stats.WEIGHT_ESTATE_ASSET | default(0.2) }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [New] 로그 상태 차트 -->
            <div class="card h-fit">
                <div class="card-header">
                    <h3 class="card-title">최근 24시간 수집 상태</h3>
                </div>
                <div class="card-p flex items-center justify-center" style="min-height: 180px;">
                    <div style="width: 140px; height: 140px; position: relative;">
                        <canvas id="logStatusChart"></canvas>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); line-height: 1.2;">Total</div>
                            <div style="font-size: 1.2rem; font-weight: 800; color: var(--text-main); line-height: 1;" id="cnt-total">0</div>
                        </div>
                    </div>
                    <div class="ml-6">
                        <div class="flex items-center gap-2 mb-1 cursor-pointer hover:opacity-75 transition" onclick="window.location.href='{{ url_for('index', status_filter='SUCCESS') }}'" title="Success 로그 필터링">
                            <span class="status-dot dot-success"></span><span class="text-sm text-sub">Success</span><span class="font-bold ml-auto" id="cnt-success">0</span>
                        </div>
                        <div class="flex items-center gap-2 mb-1 cursor-pointer hover:opacity-75 transition" onclick="window.location.href='{{ url_for('index', status_filter='FAIL') }}'" title="Fail 로그 필터링">
                            <span class="status-dot dot-danger"></span><span class="text-sm text-sub">Fail</span><span class="font-bold ml-auto" id="cnt-fail">0</span>
                        </div>
                        <div class="flex items-center gap-2 cursor-pointer hover:opacity-75 transition" onclick="window.location.href='{{ url_for('index', status_filter='SKIPPED') }}'" title="Skipped 로그 필터링">
                            <span class="status-dot" style="background:#E5E7EB;"></span><span class="text-sm text-sub">Skipped</span><span class="font-bold ml-auto" id="cnt-skipped">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const stats = {{ stats.log_stats_24h | tojson | default('{}') }};
                let success = (stats['SUCCESS'] || 0) + (stats['SUCCESS (MOCK)'] || 0);
                let fail = stats['FAIL'] || 0;
                let skipped = stats['SKIPPED'] || 0;
                
                document.getElementById('cnt-success').textContent = success;
                document.getElementById('cnt-fail').textContent = fail;
                document.getElementById('cnt-skipped').textContent = skipped;
                
                const total = success + fail + skipped;
                document.getElementById('cnt-total').textContent = total;

                const ctx = document.getElementById('logStatusChart').getContext('2d');
                
                // [M3 Style] CSS Variable Helper
                const getCssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

                // [M3 Style] Tonal Palette Colors
                const colorSuccess = getCssVar('--md-sys-color-primary') || '#E5AA70';
                const colorError = getCssVar('--md-sys-color-error') || '#BA1A1A';
                const colorSkipped = getCssVar('--md-sys-color-outline') || '#717171';
                const colorEmpty = getCssVar('--md-sys-color-surface-variant') || '#E1E3E1';
                const colorBg = getCssVar('--bg-card') || '#FFFFFF';

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Success', 'Fail', 'Skipped'],
                        datasets: [{
                            data: total === 0 ? [1] : [success, fail, skipped],
                            backgroundColor: total === 0 ? [colorEmpty] : [colorSuccess, colorError, colorSkipped],
                            borderWidth: 2,
                            borderColor: colorBg,
                            borderRadius: 20, // M3 Rounded Corners
                            hoverOffset: total === 0 ? 0 : 8,
                            spacing: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '75%', // Thinner ring for modern look
                        animation: { animateScale: true, animateRotate: true },
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                enabled: total > 0,
                                backgroundColor: getCssVar('--md-sys-color-inverse-surface') || '#313033',
                                titleColor: getCssVar('--md-sys-color-inverse-on-surface') || '#F4EFF4',
                                bodyColor: getCssVar('--md-sys-color-inverse-on-surface') || '#F4EFF4',
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: true,
                                usePointStyle: true
                            } 
                        },
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const labels = ['SUCCESS', 'FAIL', 'SKIPPED'];
                                if (labels[index]) {
                                    window.location.href = '/?status_filter=' + labels[index];
                                }
                            }
                        },
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        }
                    }
                });
            });
        </script>

        <div class="dashboard-grid">
            <!-- Card: Recent Users -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">최근 가입 회원</h3>
                    <a href="/members" class="btn-tonal btn-sm">전체보기</a>
                </div>
                <div class="card-body p-0">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>이름</th>
                                <th>ID</th>
                                <th>가입일</th>
                                <th class="text-center">상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in recent_users %}
                            <tr>
                                <td><strong class="font-semibold">{{ u.user_name }}</strong></td>
                                <td class="text-muted font-mono">{{ u.user_id }}</td>
                                <td>{{ u.join_date }}</td>
                                <td class="text-center">
                                    <span class="badge {{ 'badge-success' if u.status == 'active' else 'badge-danger' if u.status == 'suspended' else 'badge-neutral' }}">{{ u.status }}</span>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center text-muted p-4">가입 회원이 없습니다.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Card 1: Loan -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title-group">
                        <h3 class="card-title">금감원 대출상품</h3>
                        <span class="last-run">최근 실행: {{ loan_last_run | time_ago }}</span>
                    </div>
                    <div class="card-actions">
                        <span class="{{ 'badge-on' if stats.COLLECTOR_FSS_LOAN_ENABLED|default('1') == '1' else 'badge-off' }}" title="{{ '수집 활성화: 자동 수집이 실행됩니다.' if stats.COLLECTOR_FSS_LOAN_ENABLED|default('1') == '1' else '수집 비활성화: 수집 관리 메뉴에서 변경하세요.' }}">
                            {{ 'ON' if stats.COLLECTOR_FSS_LOAN_ENABLED|default('1') == '1' else 'OFF' }}
                        </span>
                        <form action="/trigger" method="post" style="margin:0;">
                            <button type="submit" name="job" value="loan" class="refresh-btn" title="금감원 대출상품 데이터를 지금 즉시 새로고침(수집)합니다.">새로고침</button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    {% with logs=loan_logs %}{% include 'components/log_table.html' %}{% endwith %}
                </div>
            </div>

            <!-- Card 2: Economy -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title-group">
                        <h3 class="card-title">경제 지표</h3>
                        <span class="last-run">최근 실행: {{ economy_last_run | time_ago }}</span>
                    </div>
                    <div class="card-actions">
                        <span class="{{ 'badge-on' if stats.COLLECTOR_ECONOMIC_ENABLED|default('1') == '1' else 'badge-off' }}" title="{{ '수집 활성화: 자동 수집이 실행됩니다.' if stats.COLLECTOR_ECONOMIC_ENABLED|default('1') == '1' else '수집 비활성화: 수집 관리 메뉴에서 변경하세요.' }}">
                            {{ 'ON' if stats.COLLECTOR_ECONOMIC_ENABLED|default('1') == '1' else 'OFF' }}
                        </span>
                        <form action="/trigger" method="post" style="margin:0;">
                            <button type="submit" name="job" value="economy" class="refresh-btn" title="경제 지표 데이터를 지금 즉시 새로고침(수집)합니다.">새로고침</button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    {% with logs=economy_logs %}{% include 'components/log_table.html' %}{% endwith %}
                </div>
            </div>

            <!-- Card 3: Income -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title-group">
                        <h3 class="card-title">통계청 소득정보</h3>
                        <span class="last-run">최근 실행: {{ income_last_run | time_ago }}</span>
                    </div>
                    <div class="card-actions">
                        <span class="{{ 'badge-on' if stats.COLLECTOR_KOSIS_INCOME_ENABLED|default('1') == '1' else 'badge-off' }}" title="{{ '수집 활성화: 자동 수집이 실행됩니다.' if stats.COLLECTOR_KOSIS_INCOME_ENABLED|default('1') == '1' else '수집 비활성화: 수집 관리 메뉴에서 변경하세요.' }}">
                            {{ 'ON' if stats.COLLECTOR_KOSIS_INCOME_ENABLED|default('1') == '1' else 'OFF' }}
                        </span>
                        <form action="/trigger" method="post" style="margin:0;">
                            <button type="submit" name="job" value="income" class="refresh-btn" title="통계청 소득정보를 지금 즉시 새로고침(수집)합니다.">새로고침</button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    {% with logs=income_logs %}{% include 'components/log_table.html' %}{% endwith %}
                </div>
            </div>
        </div>
{% endblock %}